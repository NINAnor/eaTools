# Preparing some example datasets for the eaTools package 

```{r}
library(sf)
library(tmap)
```


Import nature type data to be used as polygons containing raw variables (un-scaled indicators)
```{r}
dir <- substr(getwd(), 1,2)

path <- ifelse(dir == "C:", 
               "P:/41201785_okologisk_tilstand_2022_2023/data/Natur_Naturtyper_NiN_norge_med_svalbard_25833.gdb",
               "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/Natur_Naturtyper_NiN_norge_med_svalbard_25833.gdb")

ex_polgons <- sf::st_read(dsn = path)
```


Import map of Viken county and all its municipalities
```{r}
municipality_file <- "R:/GeoSpatialData/AdministrativeUnits/Norway_AdministrativeUnits/Converted/Norway_Municipalities/Kommune_polygon_2022_navn.shp"
municipality <- st_read(municipality_file)
```

Select five counties to focus on.
```{r}
accounting_area <- municipality[municipality$navn %in% c("Ås", "Frogn", "Nesodden", "Enebakk", "Nordre Follo"),]
```


```{r}
st_is_valid(accounting_area)
```
```{r}
st_crs(accounting_area)
```

We will stick with EPSG25833


```{r, fig.width=12}
tmap_mode("view")
tm_shape(accounting_area)+
  tm_polygons(
    col="MAP_COLORS",
    alpha=1
  )+
  tm_text("navn",
          size=3)
```

Frogn has an enclave inside Ås.

Crop the nature type data
```{r}
ex_polygons <- st_intersection(ex_polygons, accounting_area) 
```
Filter the data
```{r}
ex_polygons <- dplyr::select(ex_polygons,
                             identifikasjon_lokalid, area, SHAPE)
```

Add some random condition variable

```{r}
ex_polygons$condition_variable_1 <- rbinom(nrow(ex_polygons), 10, .5)
```

```{r}
st_crs(ex_polygons)
```
Same crs as accounting_area

```{r, fig.width=12}
tmap_mode("plot")
tm_shape(accounting_area)+
  tm_polygons(
    col="MAP_COLORS",
    alpha=1
  )+
  tm_text("navn",
          size=3)+
  tm_shape(ex_polygons)+
  tm_polygons(col = "condition_variable_1")
```

Create raster grid accross the EAA
```{r}
ex_raster <- starsExtra::make_grid(x = accounting_area,
                                   res = 1000)
```

To plot the grid we can convert the stars objects to sf. That way we can plot as polygons and visualise the individual cells.
```{r}
ex_raster_temp <- st_as_sf(ex_raster)
```

```{r, fig.width=12}
tmap_mode("plot")
tm_shape(accounting_area)+
  tm_polygons(
    col="MAP_COLORS",
    alpha=1
  )+
  tm_text("navn",
          size=3)+
  tm_shape(ex_polygons)+
  tm_polygons(col = "condition_variable_1")+
  tm_shape(ex_raster_temp)+
  tm_polygons(alpha = 0)
```

Add random values to the grid cells to represent either the value of an condition variable, the ecosystem type, or categorisation into homogenous ecological areas.
```{r}
myMat <- matrix(nrow = nrow(ex_raster),
       ncol = ncol(ex_raster),
       data = rep(round(runif(300, 1, 3)), length.out = nrow(ex_raster)*ncol(ex_raster)))
ex_raster[[1]] <- myMat

```

```{r}
tm_shape(ex_raster)+
  tm_raster(style="cat")+
  tm_layout(legend.outside = T)
```


